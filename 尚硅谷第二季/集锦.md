## Sentinel

​	Sentinel 是面向分布式服务架构的流量控制组件，主要以流量为切入点，从**限流**、**流量整形**、**熔断降级**、**系统负载保护**、**热点防护**等多个维度来帮助开发者保障微服务的稳定性。

![seata](D:\workspaces\typora\typora\尚硅谷第二季\img\seata.webp)

###  限流

### 熔断降级

## Seata

Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。

### 事务模式

#### AT模式
无侵入模式。工作流大致是：

1. TM向TC请求全局事务ID（XID），全局事务的各分支流程执行以下操作：

   > 1. 解析 SQL：得到SQL的类型，只有针对insert/update/delete类型才会开启本地事务。
   > 2. 查询前镜像：根据解析SQL得到的条件生成查询语句，将被修改的数据查询出来，并且解析成json格式。
   > 3. 执行业务SQL。
   > 4. 查询后镜像：在步骤2中查询出的数据，根据数据的id，再次将被修改的数据查询出来，称之为后镜像。
   > 5. 插入回滚日志：将前后镜像和事务ID（XID）即分支ID（BranchId）组合成一条数据插入到本地UNDO_LOG表中。
   > 6. 申请全局锁：向TC注册本分支，并且尝试获取全局锁。此处全局锁的因子主要指当前表和当前数据的id。
   > 7. 本地事务提交：本地业务SQL和本地的UNDO_LOG组成的本地事务一起提交。
   > 8. 上报本地事务结果：将本地事务的结果（提交/回滚）上报给TC。

2. TC根据各分支事务的执行结果进行最终裁决（提交/回滚）。

3. 若裁决结果为“回滚”，TC向各分支事务下发通知，各分支事务执行以下操作：

   > 1. 开启本地事务：收到TC的“回滚”请求，开启一个本地事务。
   > 2. 查找回滚记录：通过XID和BranchId查找之前的UNDO_LOG记录。
   > 3. 数据校验：校验当前数据和后镜像中的数据是否一致，一致代表数据未被修改过。否则代表该数据被其他事务更改过。
   > 4. 回滚数据：若数据校验的结果一致，则根据后镜像生成回滚SQL进行回滚。
   > 5. 冲突处理：若数据不一致，则进行其他策略的处理，比如人工干预。
   > 6. 提交本地事务：提交本地事务，并将结果上报给TC。

   

4. 若裁决的结果为“提交”，TC向各分支事务下发通知，各分支事务执行以下操作：

   > 1. 收到 TC 的分支“提交”请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。
   > 2. 异步队列中的任务将异步和批量地删除相应 UNDO LOG 记录。

#### TCC模式

TCC是一种侵入模式，不依赖于底层数据资源的事务支持，但需要自定义预备/提交/回滚逻辑。

>- 一阶段 prepare 行为：调用 **自定义** 的 prepare 逻辑。
>- 二阶段 commit 行为：调用 **自定义** 的 commit 逻辑。
>- 二阶段 rollback 行为：调用 **自定义** 的 rollback 逻辑。
>
>所谓 TCC 模式，是指支持把 **自定义** 的分支事务纳入到全局事务的管理中。

#### Saga模式

Saga模式是SEATA提供的**长事务解决方案**，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。

类似于串行化执行。用户需要自定义一阶段的正向服务和二阶段的补偿服务。

当后续分支事务失败时，反向调用之前的补偿服务。

使用场景：业务流程长，遗留项目无法提供TCC模式要求的三个接口(prepare、commit、rollback)。

优点：一阶段提交无锁，高性能；事件驱动模型，吞吐量大；补偿服务易于实现。

缺点：不能保证隔离性。






